#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <unistd.h>
//#include <video.h>

#define PI 3.14159f

#define LARGEUR 80
#define HAUTEUR 24

#define HO_YEAH 63
#define HO_RIGHT 10

#define EPICEE 360
#define HARICOT 1.0f

static char buffer[LARGEUR*HAUTEUR + 1];
float sauce[EPICEE] = {1.000000,0.999848,0.999391,0.998630,0.997564,0.996195,0.994522,0.992546,0.990268,0.987688,0.984808,0.981627,0.978148,0.974370,0.970296,0.965926,0.961262,0.956305,0.951057,0.945519,0.939693,0.933581,0.927184,0.920505,0.913546,0.906308,0.898794,0.891007,0.882948,0.874620,0.866026,0.857168,0.848048,0.838671,0.829038,0.819152,0.809017,0.798636,0.788011,0.777146,0.766045,0.754710,0.743145,0.731354,0.719340,0.707107,0.694659,0.681999,0.669131,0.656060,0.642788,0.629321,0.615662,0.601816,0.587786,0.573577,0.559194,0.544640,0.529920,0.515039,0.500001,0.484810,0.469472,0.453991,0.438372,0.422619,0.406737,0.390732,0.374607,0.358369,0.342021,0.325569,0.309018,0.292373,0.275638,0.258820,0.241923,0.224952,0.207913,0.190810,0.173649,0.156436,0.139174,0.121871,0.104530,0.087157,0.069758,0.052337,0.034901,0.017454,0.000001,-0.017451,-0.034898,-0.052335,-0.069755,-0.087154,-0.104527,-0.121868,-0.139172,-0.156433,-0.173647,-0.190808,-0.207910,-0.224950,-0.241920,-0.258818,-0.275636,-0.292370,-0.309016,-0.325567,-0.342019,-0.358366,-0.374605,-0.390730,-0.406735,-0.422617,-0.438370,-0.453989,-0.469470,-0.484808,-0.499999,-0.515037,-0.529918,-0.544638,-0.559191,-0.573575,-0.587784,-0.601814,-0.615660,-0.629319,-0.642786,-0.656058,-0.669129,-0.681997,-0.694657,-0.707105,-0.719338,-0.731352,-0.743144,-0.754708,-0.766043,-0.777145,-0.788010,-0.798634,-0.809016,-0.819151,-0.829036,-0.838669,-0.848047,-0.857166,-0.866024,-0.874619,-0.882947,-0.891006,-0.898793,-0.906307,-0.913545,-0.920504,-0.927183,-0.933580,-0.939692,-0.945518,-0.951056,-0.956304,-0.961261,-0.965925,-0.970295,-0.974370,-0.978147,-0.981627,-0.984807,-0.987688,-0.990268,-0.992546,-0.994522,-0.996194,-0.997564,-0.998629,-0.999391,-0.999848,-1.000000,-0.999848,-0.999391,-0.998630,-0.997564,-0.996195,-0.994522,-0.992546,-0.990268,-0.987689,-0.984808,-0.981628,-0.978148,-0.974371,-0.970296,-0.965927,-0.961262,-0.956306,-0.951057,-0.945519,-0.939694,-0.933581,-0.927185,-0.920506,-0.913547,-0.906309,-0.898795,-0.891008,-0.882949,-0.874621,-0.866027,-0.857169,-0.848050,-0.838672,-0.829039,-0.819154,-0.809019,-0.798637,-0.788013,-0.777148,-0.766046,-0.754712,-0.743147,-0.731356,-0.719342,-0.707109,-0.694661,-0.682001,-0.669133,-0.656061,-0.642790,-0.629323,-0.615664,-0.601818,-0.587788,-0.573579,-0.559196,-0.544642,-0.529922,-0.515041,-0.500003,-0.484813,-0.469475,-0.453994,-0.438374,-0.422621,-0.406740,-0.390734,-0.374610,-0.358371,-0.342023,-0.325571,-0.309020,-0.292375,-0.275641,-0.258823,-0.241925,-0.224955,-0.207915,-0.190813,-0.173652,-0.156438,-0.139177,-0.121873,-0.104532,-0.087159,-0.069760,-0.052340,-0.034903,-0.017456,-0.000004,0.017449,0.034896,0.052332,0.069753,0.087152,0.104525,0.121865,0.139169,0.156431,0.173644,0.190805,0.207908,0.224947,0.241918,0.258815,0.275633,0.292368,0.309013,0.325564,0.342016,0.358364,0.374603,0.390727,0.406733,0.422614,0.438367,0.453987,0.469468,0.484806,0.499996,0.515034,0.529916,0.544635,0.559189,0.573573,0.587782,0.601812,0.615658,0.629317,0.642784,0.656056,0.669127,0.681995,0.694655,0.707104,0.719337,0.731351,0.743142,0.754707,0.766042,0.777143,0.788008,0.798633,0.809014,0.819149,0.829035,0.838668,0.848046,0.857165,0.866023,0.874617,0.882945,0.891004,0.898792,0.906306,0.913544,0.920503,0.927182,0.933579,0.939691,0.945517,0.951055,0.956303,0.961260,0.965925,0.970295,0.974369,0.978147,0.981626,0.984807,0.987688,0.990267,0.992546,0.994521,0.996194,0.997564,0.998629,0.999391,0.999848};
#define GUACAMOL(x) sauce[(int)x]
float fromage[EPICEE] = {0.000000,0.017452,0.034899,0.052336,0.069756,0.087156,0.104528,0.121869,0.139173,0.156434,0.173648,0.190809,0.207912,0.224951,0.241922,0.258819,0.275637,0.292371,0.309017,0.325568,0.342020,0.358368,0.374606,0.390731,0.406736,0.422618,0.438371,0.453990,0.469471,0.484809,0.500000,0.515038,0.529919,0.544639,0.559193,0.573576,0.587785,0.601815,0.615661,0.629320,0.642787,0.656059,0.669130,0.681998,0.694658,0.707106,0.719339,0.731353,0.743144,0.754709,0.766044,0.777146,0.788010,0.798635,0.809017,0.819152,0.829037,0.838670,0.848048,0.857167,0.866025,0.874619,0.882947,0.891006,0.898794,0.906307,0.913545,0.920504,0.927183,0.933580,0.939692,0.945518,0.951056,0.956304,0.961261,0.965926,0.970295,0.974370,0.978147,0.981627,0.984808,0.987688,0.990268,0.992546,0.994522,0.996195,0.997564,0.998629,0.999391,0.999848,1.000000,0.999848,0.999391,0.998630,0.997564,0.996195,0.994522,0.992546,0.990268,0.987689,0.984808,0.981627,0.978148,0.974370,0.970296,0.965926,0.961262,0.956305,0.951057,0.945519,0.939693,0.933581,0.927184,0.920505,0.913546,0.906308,0.898795,0.891007,0.882948,0.874621,0.866026,0.857168,0.848049,0.838672,0.829039,0.819153,0.809018,0.798637,0.788012,0.777147,0.766046,0.754711,0.743146,0.731355,0.719341,0.707108,0.694660,0.682000,0.669132,0.656061,0.642789,0.629322,0.615663,0.601817,0.587787,0.573578,0.559195,0.544641,0.529921,0.515040,0.500002,0.484811,0.469473,0.453992,0.438373,0.422620,0.406739,0.390733,0.374609,0.358370,0.342022,0.325570,0.309019,0.292374,0.275640,0.258821,0.241924,0.224953,0.207914,0.190811,0.173651,0.156437,0.139175,0.121872,0.104531,0.087158,0.069759,0.052338,0.034902,0.017455,0.000003,-0.017450,-0.034897,-0.052333,-0.069754,-0.087153,-0.104526,-0.121867,-0.139170,-0.156432,-0.173646,-0.190806,-0.207909,-0.224948,-0.241919,-0.258816,-0.275635,-0.292369,-0.309014,-0.325566,-0.342017,-0.358365,-0.374604,-0.390728,-0.406734,-0.422616,-0.438369,-0.453988,-0.469469,-0.484807,-0.499997,-0.515036,-0.529917,-0.544637,-0.559190,-0.573574,-0.587783,-0.601813,-0.615659,-0.629318,-0.642785,-0.656057,-0.669128,-0.681996,-0.694656,-0.707105,-0.719338,-0.731352,-0.743143,-0.754707,-0.766042,-0.777144,-0.788009,-0.798634,-0.809015,-0.819150,-0.829036,-0.838669,-0.848046,-0.857166,-0.866024,-0.874618,-0.882946,-0.891005,-0.898793,-0.906306,-0.913544,-0.920503,-0.927183,-0.933579,-0.939691,-0.945517,-0.951055,-0.956304,-0.961261,-0.965925,-0.970295,-0.974369,-0.978147,-0.981626,-0.984807,-0.987688,-0.990268,-0.992546,-0.994522,-0.996194,-0.997564,-0.998629,-0.999391,-0.999848,-1.000000,-0.999848,-0.999391,-0.998630,-0.997564,-0.996195,-0.994522,-0.992547,-0.990269,-0.987689,-0.984808,-0.981628,-0.978148,-0.974371,-0.970297,-0.965927,-0.961263,-0.956306,-0.951058,-0.945520,-0.939694,-0.933582,-0.927185,-0.920506,-0.913547,-0.906310,-0.898796,-0.891008,-0.882950,-0.874622,-0.866028,-0.857169,-0.848050,-0.838673,-0.829040,-0.819155,-0.809020,-0.798638,-0.788013,-0.777149,-0.766047,-0.754712,-0.743148,-0.731357,-0.719343,-0.707110,-0.694662,-0.682002,-0.669134,-0.656062,-0.642791,-0.629324,-0.615665,-0.601819,-0.587789,-0.573580,-0.559197,-0.544643,-0.529923,-0.515042,-0.500004,-0.484814,-0.469476,-0.453995,-0.438375,-0.422623,-0.406741,-0.390735,-0.374611,-0.358372,-0.342025,-0.325573,-0.309022,-0.292376,-0.275642,-0.258824,-0.241927,-0.224956,-0.207916,-0.190814,-0.173653,-0.156439,-0.139178,-0.121874,-0.104533,-0.087161,-0.069761,-0.052341,-0.034905,-0.017457};
#define CHEDDAR(x) fromage[(int)x]
char mexican_food[] = "                                                                888888888888                       ,ad8888ba,     ad88888ba         88                           d8`'    ``8b   d8`     `8b        88                          d8'        `8b  Y8,                88  ,adPPYYba,   ,adPPYba,  88          88  `Y8aaaaa,          88  ``     `Y8  a8`     ``  88          88    ``````8b,        88  ,adPPPPP88  8b          Y8,        ,8P          `8b        88  88,    ,88  `8a,   ,aa   Y8a.    .a8P   Y8a     a8P        88  ``8bbdP`Y8   ``Ybbd8`'    ``Y8888Y`'     `Y88888P`                                                                  ";

void dessert(char* buffer)
{
	memset(buffer, ' ', LARGEUR*HAUTEUR); 
	buffer[LARGEUR*HAUTEUR] = '\0';
}

void entree()
{
		dessert(buffer);
}

void assaisoner(char c, int x, int y, char* buffer)
{
	if(x>=0 && x<LARGEUR && y >= 0 && y < HAUTEUR)
		buffer[x+y*LARGEUR] = c;
}

void letsdosomemagic(float sauce, float fromage, float galette, float ox, float oy, char* image,int dimx, int dimy, char* buffer) {
	int y;
	int x;
	float u = (float)ox;
	float v = (float)oy;
	float vx = sauce * galette;
	float vy = fromage * galette;
	for(y=0; y<HAUTEUR; y++) {
		
		float _u = u;
		float _v = v;
		
		for(x=0; x<LARGEUR; x++) {
			u += vx;
			v += vy;
			int xx = ((int)u)%dimx;
			int yy = ((int)v)%dimy;
			if(xx < dimx && xx >= 0 && yy <dimy && yy >= 0)
				assaisoner(image[xx + yy*dimx], x, y, buffer);
		}
		u = _u - vy;
		v = _v + vx;
	}
}

int radtodeg(float rad)
{
	int ret = (int)(rad*180.f/PI);
	if(ret < 0)
		ret+=360;
	return ret;
}
		
void lens(char* buffer1, char* buffer2, int cx, int cy,float radius,float curve)
{
	int x;
	int y;
	float vx;
	float vy;
	int xx;
	int yy;
	float u;
	float v;
	float d;
	for(y=0; y<HAUTEUR; y++)
	{
		
		for(x=0; x<LARGEUR; x++)
		{
			d = (float)((cx - x)*(cx-x) + (cy -y)*(cy -y));
			if(d < radius && d > -radius){
				d /= radius;
				d *= 1.57079633;
				vy = (cy-y)*GUACAMOL(radtodeg(d))/curve;
				vx = (cx-x)*GUACAMOL(radtodeg(d))/curve;
				u = x + vx;
				v = y + vy;
				xx = ((int)u)%LARGEUR;
				yy = ((int)v)%HAUTEUR;
				if(xx < LARGEUR && xx >= 0 && yy <HAUTEUR && yy >= 0)
				{	
					char c = buffer1[(int)xx+(int)yy*LARGEUR];
					assaisoner(c,x,y,buffer2);
				}
			}
			else
			{
				char c = buffer1[x+y*LARGEUR];
				assaisoner(c,x,y,buffer2);
			}
		}
	}
	
}

void boisson()
{
	write(1, "\033[1;1H", 8);
	write(1, buffer, LARGEUR*HAUTEUR);
}

void sombrero2()
{
	float galette = 90.0f;
	float inc = -0.5f;
	float salsa = 0;	
	int count = 0;
	
	while(count < 8)	
	{
		boisson();
		dessert(buffer);
		//printf("%x\n", sauce_table[(int)galette]);
		letsdosomemagic(GUACAMOL(salsa), CHEDDAR(salsa),GUACAMOL(galette), HO_YEAH, 50, mexican_food, HO_YEAH, HO_RIGHT, buffer);
		galette += inc;
		if(galette >= 90 || galette <= 0)
		{
			count++;
			inc = -inc;
		}
		
	}
}

void sombrero1()
{
	float x = 0.0;
	float galette = 0.35;
	while(x < 33)
	{
		boisson();
		dessert(buffer);
		letsdosomemagic(HARICOT,0.0,0.35, x, HARICOT, mexican_food, HO_YEAH, HO_RIGHT, buffer);
		x+= 0.1;
		usleep(50000);
	 }
	 sleep(2);
	 while(galette >= 0)
	 {
		boisson();
		dessert(buffer);
		letsdosomemagic(HARICOT,0.0,galette, x, HARICOT, mexican_food, HO_YEAH, HO_RIGHT, buffer);
		galette -= 0.005;
		usleep(50000);	
	}
}

void sombrero3()
{
	float salsa = 0;	
	float salsa2 = 359;
	float curve = 0.0f;
	float inc = 0.0f;
	int count = 0;
	char buffer_test[LARGEUR*HAUTEUR + 1];
	dessert(buffer_test);
	while(count<=8)	
	{
		boisson();
		dessert(buffer);
		//printf("%x\n", sauce_table[(int)galette]);
		letsdosomemagic(GUACAMOL(salsa), CHEDDAR(salsa) ,0.9f, HO_YEAH+10*GUACAMOL(salsa2), 50+10*CHEDDAR(salsa2), mexican_food, HO_YEAH, HO_RIGHT, buffer_test);
		lens(buffer_test, buffer, 40, 20, 1600, 3.0+2.0f * GUACAMOL(curve));	
		salsa += .2f;
		if(salsa > EPICEE)
			salsa = 0;
		
		salsa2 -= 1.9f;
		if(salsa2 < 0)
		{
			salsa2 = 359;
			
			count++;
		}
		if(count == 3)
			inc = 2.0f;
			
		curve += inc;
		if(curve >= 90 || curve <= 0)
		{
			inc = -inc;
		}

		
	}
}

void sombrero4()
{
	float galette = 90.0f;
	float inc = -0.5f;
	float salsa = 0;	
	
	while(salsa<EPICEE)	
	{
		boisson();
		dessert(buffer);
		letsdosomemagic(GUACAMOL(salsa), CHEDDAR(salsa) ,GUACAMOL(galette), HO_YEAH, 50, mexican_food, HO_YEAH, HO_RIGHT, buffer);
		galette += inc;
		if(galette >= 90 || galette <= 0)
			inc = -inc;
			
		salsa += .1f;
		
	}
}


int main()
{
	entree();
	sombrero1();
	sombrero2();
	sombrero4();
	sombrero3();
	while(1)
		sombrero4();
	return 0;
}
